<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Floki: /Users/svet/Proyectos/OGov/opensource2011/floki-export/src/controllers/FLContent_view_controller.m Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.4 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">Floki</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
<div class="header">
  <div class="headertitle">
<div class="title">/Users/svet/Proyectos/OGov/opensource2011/floki-export/src/controllers/FLContent_view_controller.m</div>  </div>
</div>
<div class="contents">
<div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//</span>
<a name="l00002"></a>00002 <span class="comment">// OpenIrekia v2.0 Cliente iOS</span>
<a name="l00003"></a>00003 <span class="comment">//</span>
<a name="l00004"></a>00004 <span class="comment">// Copyright 2009-2010 eFaber, S.L.</span>
<a name="l00005"></a>00005 <span class="comment">// Copyright 2009-2010 Ejie, S.A.</span>
<a name="l00006"></a>00006 <span class="comment">// Copyrigth 2009-2010 Dirección de Gobierno Abierto y Comunicación en Internet; </span>
<a name="l00007"></a>00007 <span class="comment">//    Gobernu Irekirako eta Interneteko Komunikaziorako Zuzendaritza; Lehendakaritza.</span>
<a name="l00008"></a>00008 <span class="comment">//    Gobierno Vasco – Eusko Jaurlaritza </span>
<a name="l00009"></a>00009 <span class="comment">// Licencia con arreglo a la EUPL, Versión 1.1 o –en cuanto sean aprobadas </span>
<a name="l00010"></a>00010 <span class="comment">// por la Comisión Europea– versiones posteriores de la EUPL (la Licencia);</span>
<a name="l00011"></a>00011 <span class="comment">// Solo podrá usarse esta obra si se respeta la Licencia. Puede obtenerse una </span>
<a name="l00012"></a>00012 <span class="comment">// copia de la Licencia en: http://ec.europa.eu/idabc/eupl </span>
<a name="l00013"></a>00013 <span class="comment">// Salvo cuando lo exija la legislación aplicable o se acuerde por escrito, </span>
<a name="l00014"></a>00014 <span class="comment">// el programa distribuido con arreglo a la Licencia se distribuye TAL CUAL,</span>
<a name="l00015"></a>00015 <span class="comment">// SIN GARANTÍAS NI CONDICIONES DE NINGÚN TIPO, ni expresas ni implícitas.</span>
<a name="l00016"></a>00016 <span class="comment">// Véase la Licencia en el idioma concreto que rige los permisos y limitaciones </span>
<a name="l00017"></a>00017 <span class="comment">// que establece la Licencia</span>
<a name="l00018"></a>00018 <span class="comment">//</span>
<a name="l00019"></a>00019 <span class="comment">//  http://open.irekia.net, openirekia@efaber.net</span>
<a name="l00020"></a>00020 <span class="preprocessor">#import &quot;controllers/FLContent_view_controller.h&quot;</span>
<a name="l00021"></a>00021 
<a name="l00022"></a>00022 <span class="preprocessor">#import &quot;categories/NSString+Floki.h&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#import &quot;controllers/FLSection_state.h&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#import &quot;global/FLDB.h&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#import &quot;<a class="code" href="_f_li18n_8h.html" title="Internationalization.">global/FLi18n.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#import &quot;global/settings.h&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#import &quot;ipad/FLISplit_view_controller.h&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#import &quot;models/FLContent_item.h&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#import &quot;net/FLMeta_data_connection.h&quot;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <span class="preprocessor">#import &quot;ELHASO.h&quot;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#import &quot;UIActivity.h&quot;</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="preprocessor">#import &lt;QuartzCore/CALayer.h&gt;</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#define _ACTIVITY_SIZE              40</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#define _SHIELD_TAG                 666</span>
<a name="l00039"></a>00039 <span class="preprocessor"></span><span class="preprocessor">#define _SHIELD_IMAGE_TAG           667</span>
<a name="l00040"></a>00040 <span class="preprocessor"></span><span class="preprocessor">#define _SHIELD_LABEL_TAG           668</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="keyword">@interface </span><a class="code" href="interface_f_l_content__view__controller.html" title="Common class for reusable methods.">FLContent_view_controller</a> ()
<a name="l00044"></a>00044 - (void)<a class="code" href="interface_f_l_content__view__controller.html#a5a4801bd964c08be30a2a814bc6bdcb1" title="Called whenever the layout changes (think orientation).">reposition_activity_indicator</a>;
<a name="l00045"></a>00045 - (<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a>*)replace_tags:(<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a>*)text item:(<span class="keywordtype">id</span>)item;
<a name="l00046"></a>00046 <span class="keyword">@end</span>
<a name="l00047"></a>00047 
<a name="l00048"></a>00048 
<a name="l00049"></a>00049 <span class="keyword">@implementation </span><a class="code" href="interface_f_l_content__view__controller.html" title="Common class for reusable methods.">FLContent_view_controller</a>
<a name="l00050"></a>00050 
<a name="l00051"></a>00051 <span class="keyword">@synthesize</span> <a class="code" href="interface_f_l_content__view__controller.html#a9d010f8ffa174b0acccb52c4ceab4c65" title="Base URL for the item, used to combine with item_.url if needed.">base_url</a> = base_url_;
<a name="l00052"></a>00052 <span class="keyword">@synthesize</span> <a class="code" href="interface_f_l_content__view__controller.html#a74624ba6a138b5146143e8c390ae6886" title="Internal identifier of the database cache, Owner table identifier.">cache_token</a> = cache_token_;
<a name="l00053"></a>00053 <span class="keyword">@synthesize</span> <a class="code" href="interface_f_l_content__view__controller.html#a5ec94fa2a2e148b09231337f3d8e9bb7" title="Holds a forced ULR to download stuff from, avoiding the usual URLs.">forced_url</a> = forced_url_;
<a name="l00054"></a>00054 <span class="keyword">@synthesize</span> <a class="code" href="interface_f_l_content__view__controller.html#a27c8612dc22a1df96b35276d5dd69da5" title="Set to YES if you want the controller to ignore network updates.">ignore_updates</a> = ignore_updates_;
<a name="l00055"></a>00055 <span class="keyword">@synthesize</span> <a class="code" href="interface_f_l_content__view__controller.html#a2eab99babc4345afec16a71705ac6fd0" title="Stores the items of the view.">items</a> = items_;
<a name="l00056"></a>00056 <span class="keyword">@synthesize</span> <a class="code" href="interface_f_l_content__view__controller.html#acd9f5be07580c0996698afeb42f91239" title="True absolute URL downloaded. Probably base_url + item.url.">requested_url</a> = requested_url_;
<a name="l00057"></a>00057 <span class="keyword">@synthesize</span> <a class="code" href="interface_f_l_content__view__controller.html#ae68751518d60c970f76fe8086bd8ea9b" title="Right action button. Null unless you call show_right_button:.">right_button</a> = right_button_;
<a name="l00058"></a>00058 <span class="keyword">@synthesize</span> <a class="code" href="interface_f_l_content__view__controller.html#ad5bb19f4c8176f3c759dcb6535e3167b" title="Set YES if you want push_controller: to NOT replace the root view on ipad.">same_window_push</a> = same_window_push_;
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="preprocessor">#pragma mark -</span>
<a name="l00061"></a>00061 <span class="preprocessor"></span><span class="preprocessor">#pragma mark Methods</span>
<a name="l00062"></a>00062 <span class="preprocessor"></span>
<a name="l00065"></a><a class="code" href="interface_f_l_content__view__controller.html#a279f7064f14f344dd55d911ca4e5fc3c">00065</a> - (void)<a class="code" href="interface_f_l_content__view__controller.html#a279f7064f14f344dd55d911ca4e5fc3c" title="Handles creation of the view, pseudo constructor.">loadView</a>
<a name="l00066"></a>00066 {
<a name="l00067"></a>00067     [<span class="keyword">super</span> loadView];
<a name="l00068"></a>00068 
<a name="l00069"></a>00069     <span class="keyword">self</span>.view.frame = <span class="keyword">self</span>.view.bounds;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071     <span class="comment">/* Create a hidden loading indicator. */</span>
<a name="l00072"></a>00072     <a class="code" href="interface_f_l_content__view__controller.html#af35e81b2c405ed54fa70615bb88658a1" title="Overlayed activity indicator to show loading progress.">activity_indicator_</a> = [[UIActivityIndicatorView alloc]
<a name="l00073"></a>00073         initWithActivityIndicatorStyle:UIActivityIndicatorViewStyleWhiteLarge];
<a name="l00074"></a>00074     <a class="code" href="interface_f_l_content__view__controller.html#af35e81b2c405ed54fa70615bb88658a1" title="Overlayed activity indicator to show loading progress.">activity_indicator_</a>.userInteractionEnabled = NO;
<a name="l00075"></a>00075     <a class="code" href="interface_f_l_content__view__controller.html#af35e81b2c405ed54fa70615bb88658a1" title="Overlayed activity indicator to show loading progress.">activity_indicator_</a>.frame = CGRectInset(<a class="code" href="interface_f_l_content__view__controller.html#af35e81b2c405ed54fa70615bb88658a1" title="Overlayed activity indicator to show loading progress.">activity_indicator_</a>.bounds, -5, -5);
<a name="l00076"></a>00076     <a class="code" href="interface_f_l_content__view__controller.html#af35e81b2c405ed54fa70615bb88658a1" title="Overlayed activity indicator to show loading progress.">activity_indicator_</a>.center = <span class="keyword">self</span>.view.center;
<a name="l00077"></a>00077     <a class="code" href="interface_f_l_content__view__controller.html#af35e81b2c405ed54fa70615bb88658a1" title="Overlayed activity indicator to show loading progress.">activity_indicator_</a>.autoresizingMask = FLEXIBLE_MARGINS;
<a name="l00078"></a>00078     <a class="code" href="interface_f_l_content__view__controller.html#af35e81b2c405ed54fa70615bb88658a1" title="Overlayed activity indicator to show loading progress.">activity_indicator_</a>.contentMode = UIViewContentModeCenter;
<a name="l00079"></a>00079     <a class="code" href="interface_f_l_content__view__controller.html#af35e81b2c405ed54fa70615bb88658a1" title="Overlayed activity indicator to show loading progress.">activity_indicator_</a>.backgroundColor = [UIColor colorWithRed:0
<a name="l00080"></a>00080         green:0 blue:0 alpha:0.3];
<a name="l00081"></a>00081     <a class="code" href="interface_f_l_content__view__controller.html#af35e81b2c405ed54fa70615bb88658a1" title="Overlayed activity indicator to show loading progress.">activity_indicator_</a>.layer.cornerRadius = 5;
<a name="l00082"></a>00082     [<span class="keyword">self</span>.view addSubview:activity_indicator_];
<a name="l00083"></a>00083 
<a name="l00084"></a>00084     <span class="comment">/* Create a label for error messages. */</span>
<a name="l00085"></a>00085     <a class="code" href="interface_f_l_content__view__controller.html#a31f39fba8c692480e048d92bf2425c8c" title="Label used to tell user about network outages.">error_label_</a> = [[UILabel alloc] initWithFrame:self.view.bounds];
<a name="l00086"></a>00086     <a class="code" href="interface_f_l_content__view__controller.html#a31f39fba8c692480e048d92bf2425c8c" title="Label used to tell user about network outages.">error_label_</a>.numberOfLines = 0;
<a name="l00087"></a>00087     <a class="code" href="interface_f_l_content__view__controller.html#a31f39fba8c692480e048d92bf2425c8c" title="Label used to tell user about network outages.">error_label_</a>.hidden = YES;
<a name="l00088"></a>00088     <a class="code" href="interface_f_l_content__view__controller.html#a31f39fba8c692480e048d92bf2425c8c" title="Label used to tell user about network outages.">error_label_</a>.textAlignment = UITextAlignmentCenter;
<a name="l00089"></a>00089     <a class="code" href="interface_f_l_content__view__controller.html#a31f39fba8c692480e048d92bf2425c8c" title="Label used to tell user about network outages.">error_label_</a>.autoresizingMask = FLEXIBLE_SIZE;
<a name="l00090"></a>00090     [<span class="keyword">self</span>.view addSubview:error_label_];
<a name="l00091"></a>00091 
<a name="l00092"></a>00092     <span class="comment">/* Create a hidden view for the shield image. */</span>
<a name="l00093"></a>00093     UIView *shield = [[UIView alloc] initWithFrame:self.view.bounds];
<a name="l00094"></a>00094     shield.backgroundColor = [UIColor whiteColor];
<a name="l00095"></a>00095     shield.alpha = 0;
<a name="l00096"></a>00096     shield.hidden = YES;
<a name="l00097"></a>00097     shield.tag = _SHIELD_TAG;
<a name="l00098"></a>00098     shield.contentMode = UIViewContentModeScaleAspectFit;
<a name="l00099"></a>00099     shield.autoresizingMask = UIViewAutoresizingFlexibleWidth |
<a name="l00100"></a>00100         UIViewAutoresizingFlexibleHeight;
<a name="l00101"></a>00101 
<a name="l00102"></a>00102     UIImageView *image = [[UIImageView alloc]
<a name="l00103"></a>00103         initWithImage:[UIImage imageNamed:@&quot;shield.png&quot;]];
<a name="l00104"></a>00104     image.tag = _SHIELD_IMAGE_TAG;
<a name="l00105"></a>00105     CGRect rect = image.frame;
<a name="l00106"></a>00106     CGSize size = <span class="keyword">self</span>.view.bounds.size;
<a name="l00107"></a>00107     rect.origin.x = (size.width - rect.size.width) / 2;
<a name="l00108"></a>00108     rect.origin.y = 0;
<a name="l00109"></a>00109     image.frame = rect;
<a name="l00110"></a>00110     [shield addSubview:image];
<a name="l00111"></a>00111     [image release];
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     UILabel *label = [[UILabel alloc]
<a name="l00114"></a>00114         initWithFrame:CGRectMake(0, rect.size.height, size.width, 30)];
<a name="l00115"></a>00115     label.tag = _SHIELD_LABEL_TAG;
<a name="l00116"></a>00116     label.backgroundColor = [UIColor clearColor];
<a name="l00117"></a>00117     label.text = <a class="code" href="_f_li18n_8h.html#a7ef9d4ee28c520dff25a4c42d85d8f7c" title="Retrieves an embedded string by number. See embeded_string: (FLi18n).">_e</a>(16);
<a name="l00118"></a>00118     <span class="comment">// _16: Connecting to the server...</span>
<a name="l00119"></a>00119     label.textAlignment = UITextAlignmentCenter;
<a name="l00120"></a>00120     [shield addSubview:label];
<a name="l00121"></a>00121     [label release];
<a name="l00122"></a>00122 
<a name="l00123"></a>00123     [<span class="keyword">self</span>.view addSubview:shield];
<a name="l00124"></a>00124     [shield release];
<a name="l00125"></a>00125 
<a name="l00126"></a>00126     <span class="comment">/* Get notified of landscape changes. */</span>
<a name="l00127"></a>00127     [[NSNotificationCenter defaultCenter] addObserver:self
<a name="l00128"></a>00128         selector:@selector(reposition_activity_indicator)
<a name="l00129"></a>00129         name:UIDeviceOrientationDidChangeNotification object:nil];
<a name="l00130"></a>00130 }
<a name="l00131"></a>00131 
<a name="l00134"></a><a class="code" href="interface_f_l_content__view__controller.html#ace0a686ae07026852d9ba852a1668ae0">00134</a> - (void)<a class="code" href="interface_f_l_content__view__controller.html#ace0a686ae07026852d9ba852a1668ae0" title="Frees up all resources.">dealloc</a>
<a name="l00135"></a>00135 {
<a name="l00136"></a>00136     [[NSNotificationCenter defaultCenter] removeObserver:self];
<a name="l00137"></a>00137     [<a class="code" href="interface_f_l_content__view__controller.html#a188be8d0384ae3767e6bb7c9b535bb89" title="Object tracking network connection. Allows data caching.">connection_</a> <a class="code" href="interface_f_l_remote__connection.html#ae8350e87093b9c4da9423ae7f5d70eda" title="Call this to abort the connection but not release connection memory.">cancel</a>];
<a name="l00138"></a>00138     [<a class="code" href="interface_f_l_content__view__controller.html#a188be8d0384ae3767e6bb7c9b535bb89" title="Object tracking network connection. Allows data caching.">connection_</a> release];
<a name="l00139"></a>00139     [right_button_ release];
<a name="l00140"></a>00140     [items_ release];
<a name="l00141"></a>00141     [<a class="code" href="interface_f_l_content__view__controller.html#a31f39fba8c692480e048d92bf2425c8c" title="Label used to tell user about network outages.">error_label_</a> release];
<a name="l00142"></a>00142     [<a class="code" href="interface_f_l_content__view__controller.html#af35e81b2c405ed54fa70615bb88658a1" title="Overlayed activity indicator to show loading progress.">activity_indicator_</a> release];
<a name="l00143"></a>00143     [requested_url_ release];
<a name="l00144"></a>00144     [base_url_ release];
<a name="l00145"></a>00145     [forced_url_ release];
<a name="l00146"></a>00146     [<span class="keyword">super</span> dealloc];
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 
<a name="l00150"></a><a class="code" href="interface_f_l_content__view__controller.html#a6a241bfe8215f75d6e8e379aea5cabf3">00150</a> - (void)copy_from:(<a class="code" href="interface_f_l_content__view__controller.html" title="Common class for reusable methods.">FLContent_view_controller</a>*)other
<a name="l00151"></a>00151 {
<a name="l00152"></a>00152     <span class="keyword">self</span>.<a class="code" href="interface_f_l_content__view__controller.html#acd9f5be07580c0996698afeb42f91239" title="True absolute URL downloaded. Probably base_url + item.url.">requested_url</a> = other.<a class="code" href="interface_f_l_content__view__controller.html#acd9f5be07580c0996698afeb42f91239" title="True absolute URL downloaded. Probably base_url + item.url.">requested_url</a>;
<a name="l00153"></a>00153     <span class="keyword">self</span>.base_url = other.<a class="code" href="interface_f_l_content__view__controller.html#a9d010f8ffa174b0acccb52c4ceab4c65" title="Base URL for the item, used to combine with item_.url if needed.">base_url</a>;
<a name="l00154"></a>00154     <span class="keyword">self</span>.forced_url = other.<a class="code" href="interface_f_l_content__view__controller.html#a5ec94fa2a2e148b09231337f3d8e9bb7" title="Holds a forced ULR to download stuff from, avoiding the usual URLs.">forced_url</a>;
<a name="l00155"></a>00155     <span class="keyword">self</span>.ignore_updates = other.<a class="code" href="interface_f_l_content__view__controller.html#a27c8612dc22a1df96b35276d5dd69da5" title="Set to YES if you want the controller to ignore network updates.">ignore_updates</a>;
<a name="l00156"></a>00156     <span class="keyword">self</span>.same_window_push = <span class="keyword">self</span>.same_window_push;
<a name="l00157"></a>00157 }
<a name="l00158"></a>00158 
<a name="l00163"></a><a class="code" href="interface_f_l_content__view__controller.html#a546c7868b7ecb9fbefccbbaa49371b58">00163</a> - (void)setItems:(NSArray*)new_items
<a name="l00164"></a>00164 {
<a name="l00165"></a>00165     <span class="keywordflow">if</span> (items_ == new_items)
<a name="l00166"></a>00166         <span class="keywordflow">return</span>;
<a name="l00167"></a>00167 
<a name="l00168"></a>00168     [new_items retain];
<a name="l00169"></a>00169     [items_ release];
<a name="l00170"></a>00170     items_ = new_items;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172     <a class="code" href="interface_f_l_content__view__controller.html#ad898cab2428f2a5552cf3e4b50c12b11" title="Values automatically set when you modify the list of items.">max_item_id_</a> = 0;
<a name="l00173"></a>00173     min_item_id_ = INT_MAX;
<a name="l00174"></a>00174     <span class="comment">// Remember to skip the values which are zero, we consider those invalid.</span>
<a name="l00175"></a>00175     <span class="keywordflow">for</span> (<a class="code" href="interface_f_l_content__item.html" title="Base model controller.">FLContent_item</a> *item in items_) {
<a name="l00176"></a>00176         <span class="keyword">const</span> <span class="keywordtype">int</span> value = item.id_;
<a name="l00177"></a>00177         <span class="keywordflow">if</span> (!value)
<a name="l00178"></a>00178             <span class="keywordflow">continue</span>;
<a name="l00179"></a>00179         <a class="code" href="interface_f_l_content__view__controller.html#ad898cab2428f2a5552cf3e4b50c12b11" title="Values automatically set when you modify the list of items.">max_item_id_</a> = MAX(<a class="code" href="interface_f_l_content__view__controller.html#ad898cab2428f2a5552cf3e4b50c12b11" title="Values automatically set when you modify the list of items.">max_item_id_</a>, value);
<a name="l00180"></a>00180         min_item_id_ = MIN(min_item_id_, value);
<a name="l00181"></a>00181     }
<a name="l00182"></a>00182 
<a name="l00183"></a>00183     <span class="keywordflow">if</span> (INT_MAX == min_item_id_)
<a name="l00184"></a>00184         min_item_id_ = 0;
<a name="l00185"></a>00185 }
<a name="l00186"></a>00186 
<a name="l00197"></a><a class="code" href="interface_f_l_content__view__controller.html#a253dad63511d1bd89eefaaa5b4695327">00197</a> - (void)<a class="code" href="interface_f_l_content__view__controller.html#a253dad63511d1bd89eefaaa5b4695327" title="Requests the object to start polling the remote server for news.">start_doing_network_fetches</a>
<a name="l00198"></a>00198 {
<a name="l00199"></a>00199     BLOCK_UI();
<a name="l00200"></a>00200     <span class="keywordflow">if</span> (<a class="code" href="interface_f_l_content__view__controller.html#ae6e34b1f6fc349fc848f06faa031bd20" title="Internal witness for remote network activity start.">already_doing_network_fetches_</a>)
<a name="l00201"></a>00201         <span class="keywordflow">return</span>;
<a name="l00202"></a>00202 
<a name="l00203"></a>00203     <a class="code" href="interface_f_l_content__view__controller.html#ae6e34b1f6fc349fc848f06faa031bd20" title="Internal witness for remote network activity start.">already_doing_network_fetches_</a> = YES;
<a name="l00204"></a>00204     <span class="comment">/* Set up periodic updates. Find out when we have to start checking. */</span>
<a name="l00205"></a>00205     NSDate *fire_date = 0;
<a name="l00206"></a>00206     <span class="keywordflow">if</span> (<a class="code" href="interface_f_l_content__view__controller.html#a46c0fcee825e9c72eefc038f679f043a" title="Behaviour of the news fetching when the tab is first loaded.">download_if_virgin_</a> || <span class="keyword">self</span>.<a class="code" href="interface_f_l_content__view__controller.html#a5ec94fa2a2e148b09231337f3d8e9bb7" title="Holds a forced ULR to download stuff from, avoiding the usual URLs.">forced_url</a>.length) {
<a name="l00207"></a>00207         fire_date = [NSDate date];
<a name="l00208"></a>00208     } <span class="keywordflow">else</span> {
<a name="l00209"></a>00209         <a class="code" href="interface_f_l_d_b.html" title="Wrapper around EGODatabase.">FLDB</a> *db = [<a class="code" href="interface_f_l_d_b.html" title="Wrapper around EGODatabase.">FLDB</a> <a class="code" href="interface_f_l_d_b.html#a52d0739801f8ca5ab8a6faf6ad3c1a04" title="Returns the application&#39;s pointer to the open database.">get_db</a>];
<a name="l00210"></a>00210         fire_date = [[db <a class="code" href="interface_f_l_d_b.html#a6186451960cd5a44921fbff7dca744d7" title="Returns the last modification date of the specified tab.">get_tab_timestamp</a>:unique_id_] addTimeInterval:ttl_];
<a name="l00211"></a>00211     }
<a name="l00212"></a>00212 
<a name="l00213"></a>00213     <span class="comment">//DLOG(@&quot;Fire date for %@ set to %@&quot;, langcode_url_, fire_date);</span>
<a name="l00214"></a>00214     NSTimer *timer = [[NSTimer alloc] initWithFireDate:fire_date interval:ttl_
<a name="l00215"></a>00215         target:self selector:@selector(fetch_content:) userInfo:nil
<a name="l00216"></a>00216         repeats:self.forced_url.length &lt; 1];
<a name="l00217"></a>00217 
<a name="l00218"></a>00218     [[NSRunLoop currentRunLoop] addTimer:timer forMode:NSDefaultRunLoopMode];
<a name="l00219"></a>00219     [timer release];
<a name="l00220"></a>00220 }
<a name="l00221"></a>00221 
<a name="l00233"></a><a class="code" href="interface_f_l_content__view__controller.html#a9dc4b5801f44a534d9aa580cf0a8d55f">00233</a> - (void)download_content:(<a class="code" href="interface_f_l_content__item.html" title="Base model controller.">FLContent_item</a>*)item selector:(<span class="keywordtype">SEL</span>)selector
<a name="l00234"></a>00234     target:(<span class="keywordtype">id</span>)target cache_type:(CACHE_TYPE)cache_type
<a name="l00235"></a>00235     cache_tables:(<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a>**)cache_tables force:(BOOL)force
<a name="l00236"></a>00236 {
<a name="l00237"></a>00237     LASSERT(base_url_, <span class="stringliteral">@&quot;Base url not initialised&quot;</span>);
<a name="l00238"></a>00238     LASSERT(cache_token_, <span class="stringliteral">@&quot;db_cache not initialised&quot;</span>);
<a name="l00239"></a>00239 
<a name="l00240"></a>00240     <span class="keywordflow">if</span> (!<a class="code" href="interface_f_l_content__view__controller.html#af35e81b2c405ed54fa70615bb88658a1" title="Overlayed activity indicator to show loading progress.">activity_indicator_</a>)
<a name="l00241"></a>00241         [<span class="keyword">self</span> <a class="code" href="interface_f_l_content__view__controller.html#a279f7064f14f344dd55d911ca4e5fc3c" title="Handles creation of the view, pseudo constructor.">loadView</a>];
<a name="l00242"></a>00242 
<a name="l00243"></a>00243     <span class="keyword">self</span>.navigationItem.title = item.title;
<a name="l00244"></a>00244 
<a name="l00245"></a>00245     <span class="keywordflow">if</span> (!<a class="code" href="interface_f_l_content__view__controller.html#a188be8d0384ae3767e6bb7c9b535bb89" title="Object tracking network connection. Allows data caching.">connection_</a>)
<a name="l00246"></a>00246         <a class="code" href="interface_f_l_content__view__controller.html#a188be8d0384ae3767e6bb7c9b535bb89" title="Object tracking network connection. Allows data caching.">connection_</a> = [[<a class="code" href="interface_f_l_meta__data__connection.html" title="Improvement over FLCached_connection to store data to disk.">FLMeta_data_connection</a> alloc]
<a name="l00247"></a>00247             init_with_action:selector target:target];
<a name="l00248"></a>00248     <span class="keywordflow">else</span>
<a name="l00249"></a>00249         [<a class="code" href="interface_f_l_content__view__controller.html#a188be8d0384ae3767e6bb7c9b535bb89" title="Object tracking network connection. Allows data caching.">connection_</a> <a class="code" href="interface_f_l_remote__connection.html#ae8350e87093b9c4da9423ae7f5d70eda" title="Call this to abort the connection but not release connection memory.">cancel</a>];
<a name="l00250"></a>00250 
<a name="l00251"></a>00251     <span class="keywordflow">if</span> (item) {
<a name="l00252"></a>00252         <span class="keywordflow">if</span> ([<span class="keyword">self</span>.<a class="code" href="interface_f_l_content__view__controller.html#a9d010f8ffa174b0acccb52c4ceab4c65" title="Base URL for the item, used to combine with item_.url if needed.">base_url</a> length] &gt; 0 &amp;&amp; [item.url isRelativeURL])
<a name="l00253"></a>00253             <span class="keyword">self</span>.requested_url = [<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a> stringWithFormat:@&quot;%@/%@&quot;,
<a name="l00254"></a>00254                 self.base_url, item.url];
<a name="l00255"></a>00255         <span class="keywordflow">else</span>
<a name="l00256"></a>00256             <span class="keyword">self</span>.requested_url = item.url;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258         <span class="keyword">self</span>.requested_url = [<span class="keyword">self</span> <a class="code" href="interface_f_l_content__view__controller.html#aed256339ab148c319077399b9a6e10b1" title="Returns the url with device and min/max info.">prettify_request_url</a>:self.requested_url];
<a name="l00259"></a>00259 
<a name="l00260"></a>00260         <a class="code" href="interface_f_l_content__view__controller.html#a188be8d0384ae3767e6bb7c9b535bb89" title="Object tracking network connection. Allows data caching.">connection_</a>.<a class="code" href="interface_f_l_cached__connection.html#a903c01d6a0964987317dd201da636ab2" title="Set this to YES if you want the raw FLRemote_connection behaviour.">dont_cache</a> = item.online;
<a name="l00261"></a>00261 
<a name="l00262"></a>00262         [<a class="code" href="interface_f_l_content__view__controller.html#af35e81b2c405ed54fa70615bb88658a1" title="Overlayed activity indicator to show loading progress.">activity_indicator_</a> startAnimating];
<a name="l00263"></a>00263         [<a class="code" href="interface_f_l_content__view__controller.html#a188be8d0384ae3767e6bb7c9b535bb89" title="Object tracking network connection. Allows data caching.">connection_</a> <a class="code" href="interface_f_l_meta__data__connection.html#a40c89d4027bc445b2bcb5563e8490f1c" title="Request an URL.">request</a>:self.requested_url <a class="code" href="interface_f_l_meta__data__connection.html#a40c89d4027bc445b2bcb5563e8490f1c" title="Request an URL.">news_id</a>:item.id_
<a name="l00264"></a>00264             <a class="code" href="interface_f_l_meta__data__connection.html#a40c89d4027bc445b2bcb5563e8490f1c" title="Request an URL.">cache_token</a>:cache_token_ <a class="code" href="interface_f_l_meta__data__connection.html#a40c89d4027bc445b2bcb5563e8490f1c" title="Request an URL.">cache_type</a>:cache_type
<a name="l00265"></a>00265             <a class="code" href="interface_f_l_meta__data__connection.html#a40c89d4027bc445b2bcb5563e8490f1c" title="Request an URL.">cache_tables</a>:cache_tables <a class="code" href="interface_f_l_meta__data__connection.html#a40c89d4027bc445b2bcb5563e8490f1c" title="Request an URL.">force</a>:force];
<a name="l00266"></a>00266     }
<a name="l00267"></a>00267 }
<a name="l00268"></a>00268 
<a name="l00275"></a><a class="code" href="interface_f_l_content__view__controller.html#af26c110ffa3465185d04cbe5031a12a0">00275</a> - (void)viewDidAppear:(BOOL)animated
<a name="l00276"></a>00276 {
<a name="l00277"></a>00277     [<span class="keyword">self</span> <a class="code" href="interface_f_l_content__view__controller.html#a5a4801bd964c08be30a2a814bc6bdcb1" title="Called whenever the layout changes (think orientation).">reposition_activity_indicator</a>];
<a name="l00278"></a>00278     [<span class="keyword">super</span> viewDidAppear:animated];
<a name="l00279"></a>00279 <span class="preprocessor">#if TARGET_IPHONE_SIMULATOR</span>
<a name="l00280"></a>00280 <span class="preprocessor"></span>    [<span class="keyword">self</span> performSelectorOnMainThread:@selector(simulate_memory_warning)
<a name="l00281"></a>00281         withObject:nil waitUntilDone:NO];
<a name="l00282"></a>00282 }
<a name="l00283"></a>00283 
<a name="l00285"></a>00285 - (void)simulate_memory_warning
<a name="l00286"></a>00286 {
<a name="l00287"></a>00287     simulate_memory_warning();
<a name="l00288"></a>00288     DLOG(<span class="stringliteral">@&quot;Simulated memory warning&quot;</span>);
<a name="l00289"></a>00289 <span class="preprocessor">#endif // TARGET_IPHONE_SIMULATOR</span>
<a name="l00290"></a>00290 <span class="preprocessor"></span>}
<a name="l00291"></a>00291 
<a name="l00293"></a><a class="code" href="interface_f_l_content__view__controller.html#a86f70d630e42095cec49e3220578f673">00293</a> - (BOOL)shouldAutorotateToInterfaceOrientation:
<a name="l00294"></a>00294     (UIInterfaceOrientation)interfaceOrientation
<a name="l00295"></a>00295 {
<a name="l00296"></a>00296     <span class="keywordflow">return</span> YES;
<a name="l00297"></a>00297 }
<a name="l00298"></a>00298 
<a name="l00302"></a><a class="code" href="interface_f_l_content__view__controller.html#a5a4801bd964c08be30a2a814bc6bdcb1">00302</a> - (void)<a class="code" href="interface_f_l_content__view__controller.html#a5a4801bd964c08be30a2a814bc6bdcb1" title="Called whenever the layout changes (think orientation).">reposition_activity_indicator</a>
<a name="l00303"></a>00303 {
<a name="l00304"></a>00304     CGRect rect = <span class="keyword">self</span>.view.frame;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306     <span class="comment">// Also reposition center of the shield image and its label.</span>
<a name="l00307"></a>00307     UIView *image = [<span class="keyword">self</span>.view viewWithTag:_SHIELD_IMAGE_TAG];
<a name="l00308"></a>00308     rect = image.frame;
<a name="l00309"></a>00309     CGSize size = <span class="keyword">self</span>.view.bounds.size;
<a name="l00310"></a>00310     rect.origin.x = (size.width - rect.size.width) / 2;
<a name="l00311"></a>00311     rect.origin.y = 0;
<a name="l00312"></a>00312     image.frame = rect;
<a name="l00313"></a>00313 
<a name="l00314"></a>00314     UIView *label = [<span class="keyword">self</span>.view viewWithTag:_SHIELD_LABEL_TAG];
<a name="l00315"></a>00315     label.frame = CGRectMake(0, rect.size.height, size.width, 30);
<a name="l00316"></a>00316 }
<a name="l00317"></a>00317 
<a name="l00326"></a><a class="code" href="interface_f_l_content__view__controller.html#a7cdd30e7636e8ecf74da8cd0ead91c4e">00326</a> - (BOOL)show_error:(<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a>*)message error:(NSError*)error
<a name="l00327"></a>00327 {
<a name="l00328"></a>00328     <span class="keywordflow">if</span> (!error)
<a name="l00329"></a>00329         <span class="keywordflow">return</span> NO;
<a name="l00330"></a>00330 
<a name="l00331"></a>00331     [<span class="keyword">self</span> <a class="code" href="interface_f_l_content__view__controller.html#ad2ac82673d4922ecfb79b67e959750e5" title="Shows the error message, stopping any pending activity animation.">show_error</a>:[<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a> stringWithFormat:@&quot;%@\n\n%@&quot;,
<a name="l00332"></a>00332         message, error.localizedDescription]];
<a name="l00333"></a>00333     <span class="keywordflow">return</span> YES;
<a name="l00334"></a>00334 }
<a name="l00335"></a>00335 
<a name="l00338"></a><a class="code" href="interface_f_l_content__view__controller.html#ad2ac82673d4922ecfb79b67e959750e5">00338</a> - (void)show_error:(<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a>*)message
<a name="l00339"></a>00339 {
<a name="l00340"></a>00340     <a class="code" href="interface_f_l_content__view__controller.html#a31f39fba8c692480e048d92bf2425c8c" title="Label used to tell user about network outages.">error_label_</a>.text = message;
<a name="l00341"></a>00341     <a class="code" href="interface_f_l_content__view__controller.html#a31f39fba8c692480e048d92bf2425c8c" title="Label used to tell user about network outages.">error_label_</a>.hidden = NO;
<a name="l00342"></a>00342     [<span class="keyword">self</span>.view bringSubviewToFront:error_label_];
<a name="l00343"></a>00343     [<a class="code" href="interface_f_l_content__view__controller.html#af35e81b2c405ed54fa70615bb88658a1" title="Overlayed activity indicator to show loading progress.">activity_indicator_</a> stopAnimating];
<a name="l00344"></a>00344 }
<a name="l00345"></a>00345 
<a name="l00351"></a><a class="code" href="interface_f_l_content__view__controller.html#a00123073771ed3288d7ed4783f9f5834">00351</a> - (void)show_right_button:(<span class="keywordtype">SEL</span>)action item:(UIBarButtonSystemItem)item
<a name="l00352"></a>00352 {
<a name="l00353"></a>00353     UIBarButtonItem *b =[[UIBarButtonItem alloc]
<a name="l00354"></a>00354         initWithBarButtonSystemItem:item target:self action:action];
<a name="l00355"></a>00355     b.enabled = NO;
<a name="l00356"></a>00356     <span class="keyword">self</span>.navigationItem.rightBarButtonItem = b;
<a name="l00357"></a>00357     [right_button_ release];
<a name="l00358"></a>00358     right_button_ = [b retain];
<a name="l00359"></a>00359     [b release];
<a name="l00360"></a>00360 }
<a name="l00361"></a>00361 
<a name="l00364"></a><a class="code" href="interface_f_l_content__view__controller.html#a143b20ecbe26b2119d9284216963cde3">00364</a> - (void)show_mail_composer:(<a class="code" href="interface_f_l_content__item.html" title="Base model controller.">FLContent_item</a>*)item
<a name="l00365"></a>00365     subject:(<span class="keywordtype">int</span>)subject_id body:(<span class="keywordtype">int</span>)body_id
<a name="l00366"></a>00366 {
<a name="l00367"></a>00367     LASSERT([MFMailComposeViewController canSendMail], <span class="stringliteral">@&quot;No email?&quot;</span>);
<a name="l00368"></a>00368     <span class="keywordflow">if</span> (![MFMailComposeViewController canSendMail])
<a name="l00369"></a>00369         <span class="keywordflow">return</span>;
<a name="l00370"></a>00370 
<a name="l00371"></a>00371     <a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a> *subject = <a class="code" href="_f_li18n_8h.html#aa4dd9f00a679b74b81515fe2346b1e9c" title="Retrieves a runtime string by number. See string_by_number: (FLi18n).">_</a>(subject_id);
<a name="l00372"></a>00372     <a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a> *body = <a class="code" href="_f_li18n_8h.html#aa4dd9f00a679b74b81515fe2346b1e9c" title="Retrieves a runtime string by number. See string_by_number: (FLi18n).">_</a>(body_id);
<a name="l00373"></a>00373 
<a name="l00374"></a>00374     <span class="comment">// Replace tags with attributes from the item.</span>
<a name="l00375"></a>00375     subject = [<span class="keyword">self</span> <a class="code" href="interface_f_l_content__view__controller.html#a87d6bbbd678143ceb47c6a108c32f096" title="Replaces in text the tags extracted from the content item.">replace_tags</a>:subject <a class="code" href="interface_f_l_content__view__controller.html#a87d6bbbd678143ceb47c6a108c32f096" title="Replaces in text the tags extracted from the content item.">item</a>:item];
<a name="l00376"></a>00376     body = [<span class="keyword">self</span> <a class="code" href="interface_f_l_content__view__controller.html#a87d6bbbd678143ceb47c6a108c32f096" title="Replaces in text the tags extracted from the content item.">replace_tags</a>:body <a class="code" href="interface_f_l_content__view__controller.html#a87d6bbbd678143ceb47c6a108c32f096" title="Replaces in text the tags extracted from the content item.">item</a>:item];
<a name="l00377"></a>00377 
<a name="l00378"></a>00378     MFMailComposeViewController *mail =
<a name="l00379"></a>00379         [[MFMailComposeViewController alloc] init];
<a name="l00380"></a>00380     mail.mailComposeDelegate = <span class="keyword">self</span>;
<a name="l00381"></a>00381     [mail setSubject:subject];
<a name="l00382"></a>00382     [mail setMessageBody:body isHTML:YES];
<a name="l00383"></a>00383     [<span class="keyword">self</span> presentModalViewController:mail animated:YES];
<a name="l00384"></a>00384     [mail release];
<a name="l00385"></a>00385 }
<a name="l00386"></a>00386 
<a name="l00389"></a><a class="code" href="interface_f_l_content__view__controller.html#a3d02fbaee236241c646430914a804052">00389</a> - (void)show_mail_composer:(<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a>*)to_address
<a name="l00390"></a>00390 {
<a name="l00391"></a>00391     LASSERT([MFMailComposeViewController canSendMail], <span class="stringliteral">@&quot;No email?&quot;</span>);
<a name="l00392"></a>00392     <span class="keywordflow">if</span> (![MFMailComposeViewController canSendMail])
<a name="l00393"></a>00393         <span class="keywordflow">return</span>;
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     MFMailComposeViewController *mail =
<a name="l00396"></a>00396         [[MFMailComposeViewController alloc] init];
<a name="l00397"></a>00397     mail.mailComposeDelegate = <span class="keyword">self</span>;
<a name="l00398"></a>00398     [mail setToRecipients:[NSArray arrayWithObject:to_address]];
<a name="l00399"></a>00399     [<span class="keyword">self</span> presentModalViewController:mail animated:YES];
<a name="l00400"></a>00400     [mail release];
<a name="l00401"></a>00401 }
<a name="l00402"></a>00402 
<a name="l00406"></a><a class="code" href="interface_f_l_content__view__controller.html#a87d6bbbd678143ceb47c6a108c32f096">00406</a> - (<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a>*)replace_tags:(<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a>*)text item:(<span class="keywordtype">id</span>)item
<a name="l00407"></a>00407 {
<a name="l00408"></a>00408 <span class="preprocessor">#define _REPLACE(TAG,ATTR) do {                                             \</span>
<a name="l00409"></a>00409 <span class="preprocessor">    if ([item respondsToSelector:@selector(ATTR)])                          \</span>
<a name="l00410"></a>00410 <span class="preprocessor">        text = [text stringByReplacingOccurrencesOfString:TAG               \</span>
<a name="l00411"></a>00411 <span class="preprocessor">            withString:NON_NIL_STRING(                                      \</span>
<a name="l00412"></a>00412 <span class="preprocessor">                [item performSelector:@selector(ATTR)])];                   \</span>
<a name="l00413"></a>00413 <span class="preprocessor">    else                                                                    \</span>
<a name="l00414"></a>00414 <span class="preprocessor">        text = [text stringByReplacingOccurrencesOfString:TAG               \</span>
<a name="l00415"></a>00415 <span class="preprocessor">            withString:@&quot;&quot;];\</span>
<a name="l00416"></a>00416 <span class="preprocessor">} while (0)</span>
<a name="l00417"></a>00417 <span class="preprocessor"></span>
<a name="l00418"></a>00418     _REPLACE(<span class="stringliteral">@&quot;&lt;PHOTO_DESC&gt;&quot;</span>, caption_text);
<a name="l00419"></a>00419     _REPLACE(<span class="stringliteral">@&quot;&lt;TITLE&gt;&quot;</span>, title);
<a name="l00420"></a>00420     _REPLACE(<span class="stringliteral">@&quot;&lt;URL&gt;&quot;</span>, share_url);
<a name="l00421"></a>00421 
<a name="l00422"></a>00422 <span class="preprocessor">#undef _REPLACE</span>
<a name="l00423"></a>00423 <span class="preprocessor"></span>    <span class="keywordflow">return</span> text;
<a name="l00424"></a>00424 }
<a name="l00425"></a>00425 
<a name="l00428"></a><a class="code" href="interface_f_l_content__view__controller.html#abe664a05573937d069df37af2d4e2166">00428</a> - (CGSize)<a class="code" href="interface_f_l_content__view__controller.html#abe664a05573937d069df37af2d4e2166" title="Ugly hack to return predefined sizes depending of orientation.">get_visible_area</a>
<a name="l00429"></a>00429 {
<a name="l00430"></a>00430     CGRect app_frame = [[UIScreen mainScreen] applicationFrame];
<a name="l00431"></a>00431     <span class="keywordflow">if</span> (320 == app_frame.size.width &amp;&amp; 460 == app_frame.size.height) {
<a name="l00432"></a>00432         <span class="keywordflow">return</span> CGSizeMake(320, 480);
<a name="l00433"></a>00433     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (300 == app_frame.size.width &amp;&amp; 480 == app_frame.size.height)
<a name="l00434"></a>00434         <span class="keywordflow">return</span> CGSizeMake(480, 320);
<a name="l00435"></a>00435     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (320 == app_frame.size.width || 480 == app_frame.size.height) {
<a name="l00436"></a>00436         <span class="keywordflow">return</span> CGSizeMake(320, 480);
<a name="l00437"></a>00437     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (320 == app_frame.size.width || 480 == app_frame.size.height) {
<a name="l00438"></a>00438         <span class="keywordflow">return</span> CGSizeMake(480, 320);
<a name="l00439"></a>00439     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (1024 == app_frame.size.width || 768 == app_frame.size.height) {
<a name="l00440"></a>00440         <span class="keywordflow">return</span> CGSizeMake(1024, 768);
<a name="l00441"></a>00441     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (768 == app_frame.size.width || 1024 == app_frame.size.height) {
<a name="l00442"></a>00442         <span class="keywordflow">return</span> CGSizeMake(768, 1024);
<a name="l00443"></a>00443     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (640 == app_frame.size.width || 960 == app_frame.size.height) {
<a name="l00444"></a>00444         <span class="keywordflow">return</span> CGSizeMake(640, 960);
<a name="l00445"></a>00445     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (960 == app_frame.size.width || 640 == app_frame.size.height) {
<a name="l00446"></a>00446         <span class="keywordflow">return</span> CGSizeMake(960, 640);
<a name="l00447"></a>00447     } <span class="keywordflow">else</span> {
<a name="l00448"></a>00448         DLOG(<span class="stringliteral">@&quot;Warning: unknown device size, frame %0.1fx%0.1f&quot;</span>,
<a name="l00449"></a>00449             app_frame.size.width, app_frame.size.height);
<a name="l00450"></a>00450         <span class="keywordflow">return</span> <span class="keyword">self</span>.view.bounds.size;
<a name="l00451"></a>00451     }
<a name="l00452"></a>00452 }
<a name="l00453"></a>00453 
<a name="l00460"></a><a class="code" href="interface_f_l_content__view__controller.html#ae7b4ef41262842aa547e84290ee81a73">00460</a> - (CGSize)<a class="code" href="interface_f_l_content__view__controller.html#ae7b4ef41262842aa547e84290ee81a73" title="Special visibility area version for iPad.">get_ipad_visible_area</a>
<a name="l00461"></a>00461 {
<a name="l00462"></a>00462     <span class="keywordflow">if</span> (IS_IPAD) {
<a name="l00463"></a>00463         CGSize size = [[UIScreen mainScreen] applicationFrame].size;
<a name="l00464"></a>00464         <span class="keywordflow">if</span> (748 == size.width) {
<a name="l00465"></a>00465             size.width = 1024 - 320;
<a name="l00466"></a>00466             size.height = 768;
<a name="l00467"></a>00467         } <span class="keywordflow">else</span> {
<a name="l00468"></a>00468             size.width = 768;
<a name="l00469"></a>00469             size.height = 1024;
<a name="l00470"></a>00470         }
<a name="l00471"></a>00471         <span class="keyword">const</span> CGRect rect = [[UIApplication sharedApplication] statusBarFrame];
<a name="l00472"></a>00472         <span class="keyword">const</span> CGFloat offset = MIN(rect.size.width, rect.size.height);
<a name="l00473"></a>00473         size.height -= offset;
<a name="l00474"></a>00474         <span class="keywordflow">return</span> size;
<a name="l00475"></a>00475     } <span class="keywordflow">else</span> {
<a name="l00476"></a>00476         <span class="keywordflow">return</span> [<span class="keyword">self</span> <a class="code" href="interface_f_l_content__view__controller.html#abe664a05573937d069df37af2d4e2166" title="Ugly hack to return predefined sizes depending of orientation.">get_visible_area</a>];
<a name="l00477"></a>00477     }
<a name="l00478"></a>00478 }
<a name="l00479"></a>00479 
<a name="l00488"></a><a class="code" href="interface_f_l_content__view__controller.html#a9c79d5d0fbc164ffb41bd0e2e6915946">00488</a> - (void)<a class="code" href="interface_f_l_content__view__controller.html#a9c79d5d0fbc164ffb41bd0e2e6915946" title="Puts in front of all views a shield screen.">show_shield_screen</a>
<a name="l00489"></a>00489 {
<a name="l00490"></a>00490     <span class="keywordflow">if</span> ([NSThread isMainThread])
<a name="l00491"></a>00491         [<span class="keyword">self</span> performSelector:@selector(show_shield_screen_worker)
<a name="l00492"></a>00492             withObject:nil];
<a name="l00493"></a>00493     <span class="keywordflow">else</span>
<a name="l00494"></a>00494         [<span class="keyword">self</span> performSelectorOnMainThread:@selector(show_shield_screen_worker)
<a name="l00495"></a>00495             withObject:nil waitUntilDone:YES];
<a name="l00496"></a>00496 }
<a name="l00497"></a>00497 
<a name="l00499"></a><a class="code" href="interface_f_l_content__view__controller.html#ae2e0fb1caf1a8e05d855cb53f82c90dc">00499</a> - (void)<a class="code" href="interface_f_l_content__view__controller.html#ae2e0fb1caf1a8e05d855cb53f82c90dc" title="Actual code run by show_shield_screen.">show_shield_screen_worker</a>
<a name="l00500"></a>00500 {
<a name="l00501"></a>00501     BLOCK_UI();
<a name="l00502"></a>00502     UIView *shield = [<span class="keyword">self</span>.view viewWithTag:_SHIELD_TAG];
<a name="l00503"></a>00503     [shield retain];
<a name="l00504"></a>00504     [shield removeFromSuperview];
<a name="l00505"></a>00505     shield.hidden = NO;
<a name="l00506"></a>00506     shield.alpha = 1;
<a name="l00507"></a>00507     [<span class="keyword">self</span>.view addSubview:shield];
<a name="l00508"></a>00508     [shield release];
<a name="l00509"></a>00509 
<a name="l00510"></a>00510     <span class="comment">/* Put again the activity_indicator_ in front. */</span>
<a name="l00511"></a>00511     [<a class="code" href="interface_f_l_content__view__controller.html#af35e81b2c405ed54fa70615bb88658a1" title="Overlayed activity indicator to show loading progress.">activity_indicator_</a> removeFromSuperview];
<a name="l00512"></a>00512     [<span class="keyword">self</span>.view addSubview:activity_indicator_];
<a name="l00513"></a>00513     [<a class="code" href="interface_f_l_content__view__controller.html#af35e81b2c405ed54fa70615bb88658a1" title="Overlayed activity indicator to show loading progress.">activity_indicator_</a> startAnimating];
<a name="l00514"></a>00514 }
<a name="l00515"></a>00515 
<a name="l00519"></a><a class="code" href="interface_f_l_content__view__controller.html#aacf789cad9e6ebb7fa3d5c4a9419fc18">00519</a> - (void)<a class="code" href="interface_f_l_content__view__controller.html#aacf789cad9e6ebb7fa3d5c4a9419fc18" title="Fades out the shield screen to show the contents of the view.">hide_shield_screen</a>
<a name="l00520"></a>00520 {
<a name="l00521"></a>00521     <span class="keywordflow">if</span> ([NSThread isMainThread])
<a name="l00522"></a>00522         [<span class="keyword">self</span> performSelector:@selector(hide_shield_screen_worker)
<a name="l00523"></a>00523             withObject:nil];
<a name="l00524"></a>00524     <span class="keywordflow">else</span>
<a name="l00525"></a>00525         [<span class="keyword">self</span> performSelectorOnMainThread:@selector(hide_shield_screen_worker)
<a name="l00526"></a>00526             withObject:nil waitUntilDone:YES];
<a name="l00527"></a>00527 }
<a name="l00528"></a>00528 
<a name="l00530"></a><a class="code" href="interface_f_l_content__view__controller.html#ac89acf4e0e8dc2b9218f2097de422388">00530</a> - (void)<a class="code" href="interface_f_l_content__view__controller.html#ac89acf4e0e8dc2b9218f2097de422388" title="Actual code run by hide_shield_screen.">hide_shield_screen_worker</a>
<a name="l00531"></a>00531 {
<a name="l00532"></a>00532     BLOCK_UI();
<a name="l00533"></a>00533     UIView *shield = [<span class="keyword">self</span>.view viewWithTag:_SHIELD_TAG];
<a name="l00534"></a>00534 
<a name="l00535"></a>00535     [UIView beginAnimations:nil context:NULL];
<a name="l00536"></a>00536     [UIView setAnimationDuration:1];
<a name="l00537"></a>00537     shield.alpha = 0;
<a name="l00538"></a>00538     [UIView commitAnimations];
<a name="l00539"></a>00539 
<a name="l00540"></a>00540     [<a class="code" href="interface_f_l_content__view__controller.html#af35e81b2c405ed54fa70615bb88658a1" title="Overlayed activity indicator to show loading progress.">activity_indicator_</a> stopAnimating];
<a name="l00541"></a>00541 }
<a name="l00542"></a>00542 
<a name="l00553"></a><a class="code" href="interface_f_l_content__view__controller.html#aa1f31494e0cba400b9733e2b1ae38a24">00553</a> - (void)sort_and_purge_items:(NSMutableArray*)data
<a name="l00554"></a>00554     to_delete:(NSArray*)to_delete
<a name="l00555"></a>00555 {
<a name="l00556"></a>00556     DONT_BLOCK_UI();
<a name="l00557"></a>00557     <span class="comment">/* Sort items by sorting identifier. */</span>
<a name="l00558"></a>00558     NSSortDescriptor *descriptor = [[NSSortDescriptor alloc]
<a name="l00559"></a>00559         initWithKey:@&quot;sort_id_&quot; ascending:NO];
<a name="l00560"></a>00560     [data sortUsingDescriptors:[NSArray arrayWithObject:descriptor]];
<a name="l00561"></a>00561     [descriptor release];
<a name="l00562"></a>00562 
<a name="l00563"></a>00563     <span class="comment">/* Removed items as requested by server. */</span>
<a name="l00564"></a>00564     <span class="keywordflow">if</span> (data.count &amp;&amp; to_delete) {
<a name="l00565"></a>00565         <span class="keywordflow">for</span> (NSNumber *bad_num in to_delete) {
<a name="l00566"></a>00566             <span class="keyword">const</span> <span class="keywordtype">int</span> bad_id = [bad_num intValue];
<a name="l00567"></a>00567             <span class="keywordflow">for</span> (<span class="keywordtype">int</span> f = 0; f &lt; data.count; f++) {
<a name="l00568"></a>00568                 <a class="code" href="interface_f_l_content__item.html" title="Base model controller.">FLContent_item</a> *item = [data objectAtIndex:f];
<a name="l00569"></a>00569                 <span class="keywordflow">if</span> (bad_id == item.id_) {
<a name="l00570"></a>00570                     [data removeObjectAtIndex:f];
<a name="l00571"></a>00571                     <span class="keywordflow">break</span>;
<a name="l00572"></a>00572                 }
<a name="l00573"></a>00573             }
<a name="l00574"></a>00574         }
<a name="l00575"></a>00575     }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577     <span class="keywordflow">if</span> (<span class="keyword">self</span>.<a class="code" href="interface_f_l_content__view__controller.html#a5ec94fa2a2e148b09231337f3d8e9bb7" title="Holds a forced ULR to download stuff from, avoiding the usual URLs.">forced_url</a>.length)
<a name="l00578"></a>00578         <span class="keywordflow">return</span>;
<a name="l00579"></a>00579 
<a name="l00580"></a>00580     <span class="comment">/* Remove elements whose expiration date was reached. */</span>
<a name="l00581"></a>00581     <span class="keyword">const</span> <span class="keywordtype">int</span> now = time(0);
<a name="l00582"></a>00582     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> f = 0; f &lt; data.count; f++) {
<a name="l00583"></a>00583         <a class="code" href="interface_f_l_content__item.html" title="Base model controller.">FLContent_item</a> *item = [data objectAtIndex:f];
<a name="l00584"></a>00584         <span class="keywordflow">if</span> (item.expiration_date &gt; 0 &amp;&amp; item.expiration_date &lt; now) {
<a name="l00585"></a>00585             DLOG(<span class="stringliteral">@&quot;Removing item due to expiration date %d&quot;</span>,
<a name="l00586"></a>00586                 item.expiration_date);
<a name="l00587"></a>00587             [data removeObjectAtIndex:f--];
<a name="l00588"></a>00588         }
<a name="l00589"></a>00589     }
<a name="l00590"></a>00590 }
<a name="l00591"></a>00591 
<a name="l00600"></a><a class="code" href="interface_f_l_content__view__controller.html#a5d587d65b3a6c24ac346038364145982">00600</a> - (void)save_items_to_cache:(NSArray*)items parent_table:(<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a>*)parent_table
<a name="l00601"></a>00601     data_tables:(<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a>**)data_tables owner_id:(<span class="keywordtype">int</span>)owner_id
<a name="l00602"></a>00602     max_elements:(<span class="keywordtype">int</span>)max_elements
<a name="l00603"></a>00603 {
<a name="l00604"></a>00604     RASSERT(<span class="keyword">self</span>.<a class="code" href="interface_f_l_content__view__controller.html#a5ec94fa2a2e148b09231337f3d8e9bb7" title="Holds a forced ULR to download stuff from, avoiding the usual URLs.">forced_url</a>.length &lt; 1, <span class="stringliteral">@&quot;Saving to disk forced url?&quot;</span>, <span class="keywordflow">return</span>);
<a name="l00605"></a>00605     DONT_BLOCK_UI();
<a name="l00606"></a>00606     <a class="code" href="interface_f_l_d_b.html" title="Wrapper around EGODatabase.">FLDB</a> *db = [<a class="code" href="interface_f_l_d_b.html" title="Wrapper around EGODatabase.">FLDB</a> <a class="code" href="interface_f_l_d_b.html#a52d0739801f8ca5ab8a6faf6ad3c1a04" title="Returns the application&#39;s pointer to the open database.">get_db</a>];
<a name="l00607"></a>00607     <span class="keywordtype">int</span> lowest_id = -1;
<a name="l00608"></a>00608 
<a name="l00609"></a>00609     [db beginTransaction];
<a name="l00610"></a>00610     <span class="keywordtype">int</span> saved_items = 0;
<a name="l00611"></a>00611     <span class="keywordflow">for</span> (<a class="code" href="interface_f_l_content__item.html" title="Base model controller.">FLContent_item</a> *item in <a class="code" href="interface_f_l_content__view__controller.html#a2eab99babc4345afec16a71705ac6fd0" title="Stores the items of the view.">items</a>) {
<a name="l00612"></a>00612         <a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a> *json_string = [item <a class="code" href="interface_f_l_content__item.html#a628b0fbd99908b9cffe31c34ab3e1dec" title="Generates the JSON string with the object representation.">create_json</a>];
<a name="l00613"></a>00613         <span class="keywordflow">if</span> (json_string.length &lt; 1)
<a name="l00614"></a>00614             <span class="keywordflow">continue</span>;
<a name="l00615"></a>00615 
<a name="l00616"></a>00616         [db <a class="code" href="interface_f_l_d_b.html#a5129667e376e72592d53f8ca03bce527" title="Saves into the database the specified meta item with owner.">save_meta_item</a>:parent_table <a class="code" href="interface_f_l_d_b.html#a5129667e376e72592d53f8ca03bce527" title="Saves into the database the specified meta item with owner.">data</a>:json_string
<a name="l00617"></a>00617             <a class="code" href="interface_f_l_d_b.html#a5129667e376e72592d53f8ca03bce527" title="Saves into the database the specified meta item with owner.">the_id</a>:item.id_ <a class="code" href="interface_f_l_d_b.html#a5129667e376e72592d53f8ca03bce527" title="Saves into the database the specified meta item with owner.">owner</a>:owner_id];
<a name="l00618"></a>00618         saved_items++;
<a name="l00619"></a>00619 
<a name="l00620"></a>00620         <span class="keywordflow">if</span> (lowest_id &lt; 0)
<a name="l00621"></a>00621             lowest_id = item.id_;
<a name="l00622"></a>00622         <span class="keywordflow">else</span>
<a name="l00623"></a>00623             lowest_id = MIN(lowest_id, item.id_);
<a name="l00624"></a>00624 
<a name="l00625"></a>00625         <span class="keywordflow">if</span> (saved_items &gt;= max_elements)
<a name="l00626"></a>00626             <span class="keywordflow">break</span>;
<a name="l00627"></a>00627     }
<a name="l00628"></a>00628     [db commitTransaction];
<a name="l00629"></a>00629 
<a name="l00630"></a>00630     [db <a class="code" href="interface_f_l_d_b.html#ac9eee38c03ba958d52780622f75fd18e" title="Purges entries from the meta table.">purge_stale_meta_items</a>:parent_table <a class="code" href="interface_f_l_d_b.html#ac9eee38c03ba958d52780622f75fd18e" title="Purges entries from the meta table.">data_tables</a>:data_tables
<a name="l00631"></a>00631         <a class="code" href="interface_f_l_d_b.html#ac9eee38c03ba958d52780622f75fd18e" title="Purges entries from the meta table.">lowest_id</a>:lowest_id <a class="code" href="interface_f_l_d_b.html#ac9eee38c03ba958d52780622f75fd18e" title="Purges entries from the meta table.">owner</a>:owner_id];
<a name="l00632"></a>00632     <span class="comment">/* Indicate for the future the last time the cache was updated. */</span>
<a name="l00633"></a>00633     [db <a class="code" href="interface_f_l_d_b.html#a29d79ad65643f2c107b2bf1077e4b74d" title="Updates the tab timestamp to the current time.">touch_tab_timestamp</a>:owner_id];
<a name="l00634"></a>00634 }
<a name="l00635"></a>00635 
<a name="l00642"></a><a class="code" href="interface_f_l_content__view__controller.html#aeaf1bd7cfdb67d705cf53c2f23ea6acd">00642</a> - (void)push_controller:(UIViewController*)controller animated:(BOOL)animated
<a name="l00643"></a>00643 {
<a name="l00644"></a>00644     <span class="keywordflow">if</span> (IS_IPAD &amp;&amp; !<span class="keyword">self</span>.<a class="code" href="interface_f_l_content__view__controller.html#ad5bb19f4c8176f3c759dcb6535e3167b" title="Set YES if you want push_controller: to NOT replace the root view on ipad.">same_window_push</a>) {
<a name="l00645"></a>00645         <span class="comment">/* Try to traverse upwards the hierarchy for the split controller. */</span>
<a name="l00646"></a>00646         <span class="keywordtype">id</span> parent = ASK_GETTER(<span class="keyword">self</span>, splitViewController,
<a name="l00647"></a>00647             <span class="keyword">self</span>.navigationController.parentViewController);
<a name="l00648"></a>00648         <span class="keywordflow">while</span> (parent) {
<a name="l00649"></a>00649             <span class="keywordflow">if</span> ([parent isKindOfClass:[<a class="code" href="interface_f_l_i_split__view__controller.html" title="Handles the iPad root view.">FLISplit_view_controller</a> <span class="keyword">class</span>]]) {
<a name="l00650"></a>00650                 FLISplit_view_controller *split_controller = parent;
<a name="l00651"></a>00651                 [split_controller <a class="code" href="interface_f_l_i_split__view__controller.html#a2a3c5fafdd82a56842b0e6f8f01567db" title="Modifies the detail controller to be what is being passed.">set_detail_controller</a>:controller];
<a name="l00652"></a>00652                 <span class="keywordflow">return</span>;
<a name="l00653"></a>00653             } <span class="keywordflow">else</span> {
<a name="l00654"></a>00654                 <span class="keywordtype">SEL</span> get_parent = <span class="keyword">@selector</span>(parentViewController);
<a name="l00655"></a>00655                 <span class="keywordflow">if</span> ([parent respondsToSelector:get_parent])
<a name="l00656"></a>00656                     parent = [parent performSelector:get_parent withObject:nil];
<a name="l00657"></a>00657                 <span class="keywordflow">else</span>
<a name="l00658"></a>00658                     parent = nil;
<a name="l00659"></a>00659             }
<a name="l00660"></a>00660         }
<a name="l00661"></a>00661     }
<a name="l00662"></a>00662     <span class="comment">// Propagate same_window_push attribute if possible.</span>
<a name="l00663"></a>00663     <span class="keywordflow">if</span> ([controller respondsToSelector:<span class="keyword">@selector</span>(setSame_window_push:)]) {
<a name="l00664"></a>00664         <a class="code" href="interface_f_l_content__view__controller.html" title="Common class for reusable methods.">FLContent_view_controller</a> *c = (id)controller;
<a name="l00665"></a>00665         c.<a class="code" href="interface_f_l_content__view__controller.html#ad5bb19f4c8176f3c759dcb6535e3167b" title="Set YES if you want push_controller: to NOT replace the root view on ipad.">same_window_push</a> = <span class="keyword">self</span>.same_window_push;
<a name="l00666"></a>00666     }
<a name="l00667"></a>00667     [<span class="keyword">self</span>.navigationController pushViewController:controller animated:animated];
<a name="l00668"></a>00668 }
<a name="l00669"></a>00669 
<a name="l00679"></a><a class="code" href="interface_f_l_content__view__controller.html#aed256339ab148c319077399b9a6e10b1">00679</a> - (<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a>*)prettify_request_url:(<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a>*)url
<a name="l00680"></a>00680 {
<a name="l00681"></a>00681     <span class="keywordflow">if</span> (!url)
<a name="l00682"></a>00682         <span class="keywordflow">return</span> nil;
<a name="l00683"></a>00683 
<a name="l00684"></a>00684     NSMutableArray *params = [NSMutableArray arrayWithCapacity:3];
<a name="l00685"></a>00685     <span class="keyword">const</span> <span class="keywordtype">int</span> device_id = get_device_identifier();
<a name="l00686"></a>00686     <span class="keywordflow">if</span> (device_id &gt; 0)
<a name="l00687"></a>00687         [params addObject:[<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a> stringWithFormat:@&quot;d=%d&quot;, device_id]];
<a name="l00688"></a>00688 
<a name="l00689"></a>00689     <span class="keywordflow">if</span> (min_item_id_ &gt; 0)
<a name="l00690"></a>00690         [params addObject:[<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a> stringWithFormat:@&quot;l=%d&quot;, min_item_id_]];
<a name="l00691"></a>00691 
<a name="l00692"></a>00692     <span class="keywordflow">if</span> (<a class="code" href="interface_f_l_content__view__controller.html#ad898cab2428f2a5552cf3e4b50c12b11" title="Values automatically set when you modify the list of items.">max_item_id_</a> &gt; 0)
<a name="l00693"></a>00693         [params addObject:[<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a> stringWithFormat:@&quot;h=%d&quot;, max_item_id_]];
<a name="l00694"></a>00694 
<a name="l00695"></a>00695     <span class="keywordflow">if</span> (params.count &lt; 1)
<a name="l00696"></a>00696         <span class="keywordflow">return</span> [<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a> stringWithString:url];
<a name="l00697"></a>00697 
<a name="l00698"></a>00698     <a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a> *p = [params componentsJoinedByString:@&quot;&amp;&quot;];
<a name="l00699"></a>00699     NSRange range = [url rangeOfString:@&quot;?&quot;];
<a name="l00700"></a>00700     <span class="keywordflow">if</span> (NSNotFound == range.location)
<a name="l00701"></a>00701         <span class="keywordflow">return</span> [url stringByAppendingFormat:@&quot;?%@&quot;, p];
<a name="l00702"></a>00702     <span class="keywordflow">else</span>
<a name="l00703"></a>00703         <span class="keywordflow">return</span> [url stringByAppendingFormat:@&quot;&amp;%@&quot;, p];
<a name="l00704"></a>00704 }
<a name="l00705"></a>00705 
<a name="l00708"></a>00708 + (<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a>*)prettify_request_url:(<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a>*)url
<a name="l00709"></a>00709 {
<a name="l00710"></a>00710     <span class="keywordflow">if</span> (!url)
<a name="l00711"></a>00711         <span class="keywordflow">return</span> nil;
<a name="l00712"></a>00712 
<a name="l00713"></a>00713     <span class="keyword">const</span> <span class="keywordtype">int</span> device_id = get_device_identifier();
<a name="l00714"></a>00714     <span class="keywordflow">if</span> (device_id &lt; 1)
<a name="l00715"></a>00715         <span class="keywordflow">return</span> [<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a> stringWithString:url];
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     NSRange range = [url rangeOfString:@&quot;?&quot;];
<a name="l00718"></a>00718     <span class="keywordflow">if</span> (NSNotFound == range.location)
<a name="l00719"></a>00719         <span class="keywordflow">return</span> [url stringByAppendingFormat:@&quot;?d=%d&quot;, device_id];
<a name="l00720"></a>00720     <span class="keywordflow">else</span>
<a name="l00721"></a>00721         <span class="keywordflow">return</span> [url stringByAppendingFormat:@&quot;&amp;d=%d&quot;, device_id];
<a name="l00722"></a>00722 }
<a name="l00723"></a>00723 
<a name="l00728"></a><a class="code" href="interface_f_l_content__view__controller.html#a393d6fcf281d670ba9444fbb75a1ddb6">00728</a> - (<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a>*)prettify_request_url:(<a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a>*)url add_older:(BOOL)add_older
<a name="l00729"></a>00729 {
<a name="l00730"></a>00730     <a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a> *ret = [<span class="keyword">self</span> <a class="code" href="interface_f_l_content__view__controller.html#aed256339ab148c319077399b9a6e10b1" title="Returns the url with device and min/max info.">prettify_request_url</a>:url];
<a name="l00731"></a>00731     <span class="keywordflow">if</span> (!add_older || <span class="keyword">self</span>.<a class="code" href="interface_f_l_content__view__controller.html#a2eab99babc4345afec16a71705ac6fd0" title="Stores the items of the view.">items</a>.count &lt; 1)
<a name="l00732"></a>00732         <span class="keywordflow">return</span> ret;
<a name="l00733"></a>00733 
<a name="l00735"></a>00735     <span class="keywordtype">int</span> param = 0;
<a name="l00736"></a>00736     <span class="keywordflow">for</span> (<a class="code" href="interface_f_l_content__item.html" title="Base model controller.">FLContent_item</a> *item in [<span class="keyword">self</span>.<a class="code" href="interface_f_l_content__view__controller.html#a2eab99babc4345afec16a71705ac6fd0" title="Stores the items of the view.">items</a> reverseObjectEnumerator]) {
<a name="l00737"></a>00737         <span class="keyword">const</span> <span class="keywordtype">int</span> value = item.id_;
<a name="l00738"></a>00738         <span class="keywordflow">if</span> (value) {
<a name="l00739"></a>00739             param = value;
<a name="l00740"></a>00740             <span class="keywordflow">break</span>;
<a name="l00741"></a>00741         }
<a name="l00742"></a>00742     }
<a name="l00743"></a>00743     <span class="keywordflow">if</span> (!param)
<a name="l00744"></a>00744         <span class="keywordflow">return</span> ret;
<a name="l00745"></a>00745 
<a name="l00746"></a>00746     NSRange range = [ret rangeOfString:@&quot;?&quot;];
<a name="l00747"></a>00747     <span class="keywordflow">if</span> (NSNotFound == range.location)
<a name="l00748"></a>00748         <span class="keywordflow">return</span> [ret stringByAppendingFormat:@&quot;?o=%d&quot;, param];
<a name="l00749"></a>00749     <span class="keywordflow">else</span>
<a name="l00750"></a>00750         <span class="keywordflow">return</span> [ret stringByAppendingFormat:@&quot;&amp;o=%d&quot;, param];
<a name="l00751"></a>00751 }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753 
<a name="l00754"></a>00754 <span class="preprocessor">#pragma mark UIActionSheet</span>
<a name="l00755"></a>00755 <span class="preprocessor"></span>
<a name="l00758"></a><a class="code" href="interface_f_l_content__view__controller.html#a44b3cce406f3b1fc471512db1ead20c6">00758</a> - (void)show_share_actions:(<span class="keywordtype">int</span>)title_id
<a name="l00759"></a>00759 {
<a name="l00760"></a>00760     [<span class="keyword">self</span> <a class="code" href="interface_f_l_content__view__controller.html#a7d5dd5b2b65d4e84406aa0e4c882bbb7" title="If there is an action sheet, it will be cancelled.">cancel_previous_action_sheet</a>];
<a name="l00761"></a>00761 
<a name="l00762"></a>00762     <a class="code" href="interface_f_l_content__view__controller.html#ab1fc2c1a51831bfe854d9a3eee6914ca" title="Stores the last action sheet. Required to dismiss it on the ipad.">last_sheet_</a> = [[UIActionSheet alloc]
<a name="l00763"></a>00763         initWithTitle:_(title_id) delegate:self cancelButtonTitle:nil
<a name="l00764"></a>00764         destructiveButtonTitle:nil otherButtonTitles:nil];
<a name="l00765"></a>00765 
<a name="l00766"></a>00766     [<a class="code" href="interface_f_l_content__view__controller.html#ab1fc2c1a51831bfe854d9a3eee6914ca" title="Stores the last action sheet. Required to dismiss it on the ipad.">last_sheet_</a> addButtonWithTitle:_(STR_COPY_TO_CLIPBOARD)];
<a name="l00767"></a>00767     <span class="keywordflow">if</span> ([MFMailComposeViewController canSendMail])
<a name="l00768"></a>00768         [<a class="code" href="interface_f_l_content__view__controller.html#ab1fc2c1a51831bfe854d9a3eee6914ca" title="Stores the last action sheet. Required to dismiss it on the ipad.">last_sheet_</a> addButtonWithTitle:_(STR_SEND_EMAIL)];
<a name="l00769"></a>00769 
<a name="l00770"></a>00770     [<a class="code" href="interface_f_l_content__view__controller.html#ab1fc2c1a51831bfe854d9a3eee6914ca" title="Stores the last action sheet. Required to dismiss it on the ipad.">last_sheet_</a> addButtonWithTitle:_(STR_TWITTER_BUTTON)];
<a name="l00771"></a>00771     [<a class="code" href="interface_f_l_content__view__controller.html#ab1fc2c1a51831bfe854d9a3eee6914ca" title="Stores the last action sheet. Required to dismiss it on the ipad.">last_sheet_</a> addButtonWithTitle:_(STR_FACEBOOK_BUTTON)];
<a name="l00772"></a>00772     [<a class="code" href="interface_f_l_content__view__controller.html#ab1fc2c1a51831bfe854d9a3eee6914ca" title="Stores the last action sheet. Required to dismiss it on the ipad.">last_sheet_</a> addButtonWithTitle:_(STR_CANCEL_ACTION)];
<a name="l00773"></a>00773     <a class="code" href="interface_f_l_content__view__controller.html#ab1fc2c1a51831bfe854d9a3eee6914ca" title="Stores the last action sheet. Required to dismiss it on the ipad.">last_sheet_</a>.cancelButtonIndex = <a class="code" href="interface_f_l_content__view__controller.html#ab1fc2c1a51831bfe854d9a3eee6914ca" title="Stores the last action sheet. Required to dismiss it on the ipad.">last_sheet_</a>.numberOfButtons - 1;
<a name="l00774"></a>00774 
<a name="l00775"></a>00775     <span class="keywordflow">if</span> (IS_IPAD) {
<a name="l00776"></a>00776         <span class="keywordtype">id</span> split_view = ASK_GETTER(<span class="keyword">self</span>, splitViewController, nil);
<a name="l00777"></a>00777         ASK_GETTER(split_view, dismiss_pop_over, nil);
<a name="l00778"></a>00778         [<a class="code" href="interface_f_l_content__view__controller.html#ab1fc2c1a51831bfe854d9a3eee6914ca" title="Stores the last action sheet. Required to dismiss it on the ipad.">last_sheet_</a> performSelector:@selector(showFromBarButtonItem:)
<a name="l00779"></a>00779             withObject:self.right_button];
<a name="l00780"></a>00780     } <span class="keywordflow">else</span> {
<a name="l00781"></a>00781         [<a class="code" href="interface_f_l_content__view__controller.html#ab1fc2c1a51831bfe854d9a3eee6914ca" title="Stores the last action sheet. Required to dismiss it on the ipad.">last_sheet_</a> showInView:self.view];
<a name="l00782"></a>00782     }
<a name="l00783"></a>00783 }
<a name="l00784"></a>00784 
<a name="l00789"></a><a class="code" href="interface_f_l_content__view__controller.html#a7d5dd5b2b65d4e84406aa0e4c882bbb7">00789</a> - (void)<a class="code" href="interface_f_l_content__view__controller.html#a7d5dd5b2b65d4e84406aa0e4c882bbb7" title="If there is an action sheet, it will be cancelled.">cancel_previous_action_sheet</a>
<a name="l00790"></a>00790 {
<a name="l00791"></a>00791     <span class="keywordflow">if</span> (<a class="code" href="interface_f_l_content__view__controller.html#ab1fc2c1a51831bfe854d9a3eee6914ca" title="Stores the last action sheet. Required to dismiss it on the ipad.">last_sheet_</a>) {
<a name="l00792"></a>00792         [<a class="code" href="interface_f_l_content__view__controller.html#ab1fc2c1a51831bfe854d9a3eee6914ca" title="Stores the last action sheet. Required to dismiss it on the ipad.">last_sheet_</a>
<a name="l00793"></a>00793             dismissWithClickedButtonIndex:last_sheet_.cancelButtonIndex
<a name="l00794"></a>00794             animated:NO];
<a name="l00795"></a>00795     }
<a name="l00796"></a>00796 }
<a name="l00797"></a>00797 
<a name="l00798"></a>00798 - (void)actionSheet:(UIActionSheet *)actionSheet
<a name="l00799"></a>00799     clickedButtonAtIndex:(NSInteger)buttonIndex
<a name="l00800"></a>00800 {
<a name="l00801"></a>00801     <span class="keywordflow">if</span> (![<span class="keyword">self</span> respondsToSelector:<span class="keyword">@selector</span>(handle_action:)])
<a name="l00802"></a>00802         <span class="keywordflow">return</span>;
<a name="l00803"></a>00803 
<a name="l00804"></a>00804     <span class="keywordflow">if</span> (actionSheet.cancelButtonIndex == buttonIndex) {
<a name="l00805"></a>00805         DLOG(<span class="stringliteral">@&quot;Actionsheet cancelled.&quot;</span>);
<a name="l00806"></a>00806         NSNumber *param = [NSNumber numberWithInt:ACTION_CANCEL];
<a name="l00807"></a>00807         [<span class="keyword">self</span> performSelector:@selector(handle_action:) withObject:param];
<a name="l00808"></a>00808         <span class="keywordflow">return</span>;
<a name="l00809"></a>00809     }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811     Action_button action = ACTION_UNKNOWN;
<a name="l00812"></a>00812     <a class="code" href="class_n_s_string.html" title="Appends some custom helpers to NSString.">NSString</a> *title = [actionSheet buttonTitleAtIndex:buttonIndex];
<a name="l00813"></a>00813     <span class="keywordflow">if</span> ([title isEqualToString:<a class="code" href="_f_li18n_8h.html#aa4dd9f00a679b74b81515fe2346b1e9c" title="Retrieves a runtime string by number. See string_by_number: (FLi18n).">_</a>(STR_COPY_TO_CLIPBOARD)])
<a name="l00814"></a>00814         action = ACTION_COPY_URL;
<a name="l00815"></a>00815     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ([title isEqualToString:<a class="code" href="_f_li18n_8h.html#aa4dd9f00a679b74b81515fe2346b1e9c" title="Retrieves a runtime string by number. See string_by_number: (FLi18n).">_</a>(STR_SEND_EMAIL)])
<a name="l00816"></a>00816         action = ACTION_MAIL_URL;
<a name="l00817"></a>00817     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ([title isEqualToString:<a class="code" href="_f_li18n_8h.html#aa4dd9f00a679b74b81515fe2346b1e9c" title="Retrieves a runtime string by number. See string_by_number: (FLi18n).">_</a>(STR_TWITTER_BUTTON)])
<a name="l00818"></a>00818         action = ACTION_TWIT_URL;
<a name="l00819"></a>00819     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ([title isEqualToString:<a class="code" href="_f_li18n_8h.html#aa4dd9f00a679b74b81515fe2346b1e9c" title="Retrieves a runtime string by number. See string_by_number: (FLi18n).">_</a>(STR_FACEBOOK_BUTTON)])
<a name="l00820"></a>00820         action = ACTION_FACEBOOK_URL;
<a name="l00821"></a>00821 
<a name="l00822"></a>00822     NSNumber *param = [NSNumber numberWithInt:action];
<a name="l00823"></a>00823     [<span class="keyword">self</span> performSelector:@selector(handle_action:) withObject:param];
<a name="l00824"></a>00824 }
<a name="l00825"></a>00825 
<a name="l00826"></a>00826 - (void)actionSheet:(UIActionSheet *)actionSheet
<a name="l00827"></a>00827     willDismissWithButtonIndex:(NSInteger)buttonIndex
<a name="l00828"></a>00828 {
<a name="l00829"></a>00829     LASSERT(<a class="code" href="interface_f_l_content__view__controller.html#ab1fc2c1a51831bfe854d9a3eee6914ca" title="Stores the last action sheet. Required to dismiss it on the ipad.">last_sheet_</a>, <span class="stringliteral">@&quot;Uh oh, not tracking properly the action sheets.&quot;</span>);
<a name="l00830"></a>00830     [last_sheet_ release];
<a name="l00831"></a>00831     <a class="code" href="interface_f_l_content__view__controller.html#ab1fc2c1a51831bfe854d9a3eee6914ca" title="Stores the last action sheet. Required to dismiss it on the ipad.">last_sheet_</a> = nil;
<a name="l00832"></a>00832 }
<a name="l00833"></a>00833 
<a name="l00834"></a>00834 <span class="preprocessor">#pragma mark MFMailComposeViewControllerDelegate</span>
<a name="l00835"></a>00835 <span class="preprocessor"></span>
<a name="l00838"></a><a class="code" href="interface_f_l_content__view__controller.html#ad29286e74e635debe4f8e53f7aafd3eb">00838</a> - (void)mailComposeController:(MFMailComposeViewController*)controller
<a name="l00839"></a>00839     didFinishWithResult:(MFMailComposeResult)result error:(NSError*)error
<a name="l00840"></a>00840 {
<a name="l00841"></a>00841     DLOG(<span class="stringliteral">@&quot;Did mail fail? %@&quot;</span>, error);
<a name="l00842"></a>00842     [<span class="keyword">self</span> dismissModalViewControllerAnimated:YES];
<a name="l00843"></a>00843 }
<a name="l00844"></a>00844 
<a name="l00845"></a>00845 <span class="keyword">@end</span>
</pre></div></div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Wed Jan 18 2012 15:31:24 for Floki by&#160;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.4 </small></address>
</body>
</html>
